#!/usr/bin/env node

require('dotenv').load({ silent: true });

var util = require('util');
var yargs = require('yargs');
var Migration = require('../lib/migration');
var MigrationRunner = require('../lib/runner');

process.on('uncaughtException', function(err) {
  console.log(err.stack);
  process.exit(1);
});

var argv = yargs
  .usage('Usage: db-migrate [up|down|create] migrationName [options]')

  .option('d', {
    alias: 'database-url-var',
    default: 'DATABASE_URL',
    describe: 'Name of env variable where is set the database_url',
    type: 'string'
  })

  .option('m', {
    alias: 'migrations-dir',
    default: process.cwd() + '/migrations',
    defaultDescription: 'migrations',
    describe: 'The directory containing your migration files',
    type: 'string'
  })

  .option('t', {
    alias: 'migrations-table',
    default: 'pgmigrations',
    describe: 'The table storing which migrations have been run',
    type: 'string'
  })

  .option('s', {
    alias: 'migrations-schema',
    default: 'public',
    describe: 'The schema storing table which migrations have been run',
    type: 'string'
  })

  .option('dry-run', {
    default: false,
    describe: 'Prints the SQL but doesn\'t run it',
    type: 'boolean'
  })

  .option('check-order', {
    default: false,
    describe: 'Check order of migrations before running them',
    type: 'boolean'
  })

  .option('v', {
    alias: 'verbose',
    default: false,
    describe: 'Verbose mode',
    type: 'boolean'
  })

  .option('i', {
    alias: 'version',
    default: false,
    describe: 'Print version info',
    type: 'boolean'
  })

  .help()
  .argv;

if (argv.version) {
  console.log(module.exports.version);
  process.exit(0);
}

if (argv.help || argv._.length === 0) {
  yargs.showHelp();
  process.exit(1);
}

global.verbose = argv.verbose;
global.dryRun = argv['dry-run'];
if (global.dryRun) {
  console.log('dry run');
}


var MIGRATIONS_DIR = argv['migrations-dir'];
var DATABASE_URL = process.env[argv['database-url-var']];
var MIGRATIONS_SCHEMA = argv['migrations-schema'];
var MIGRATIONS_TABLE = argv['migrations-table'];

if (!DATABASE_URL) {
  console.error('The $' + argv['database-url-var'] + ' environment variable is not set.');
  process.exit(1);
}

var action = argv._.shift();

if (action === 'create') {
  // replaces spaces with dashes - should help fix some errors
  var new_migration_name = argv._.length ? argv._.join('-') : '';
  // forces use of dashes in names - keep thing clean
  new_migration_name = new_migration_name.replace(/_ /g, '-');

  if (!new_migration_name) {
    console.log('\'migrationName\' is required.');
    yargs.showHelp();
    process.exit(1);
  }

  var migration = Migration.create(new_migration_name, MIGRATIONS_DIR);
  console.log(util.format('Created migration -- %s', migration.path));
} else if (action === 'up' || action === 'down') {
  var updown_arg = argv._.length ? argv._.shift() : null;
  var num_migrations;
  var migration_name;

  if (updown_arg !== null) {
    if (parseInt(updown_arg) == updown_arg) { // eslint-disable-line eqeqeq
      num_migrations = parseInt(updown_arg);
    } else {
      migration_name = argv._.join('-').replace(/_ /g, '-');
    }
  }

  var runner = new MigrationRunner({
    database_url: DATABASE_URL,
    dir: MIGRATIONS_DIR,
    migrations_schema: MIGRATIONS_SCHEMA,
    migrations_table: MIGRATIONS_TABLE,
    direction: action,
    count: num_migrations,
    file: migration_name,
    checkOrder: argv['check-order'],
  });

  runner.run(function(err) {
    // finish -- show some logging about what happened?
    if (err) {
      console.log(err.stack);
      process.exit(1);
    }
    console.log('Migrations complete!');
    process.exit(0);
  });
} else {
  console.log('Invalid Action: Must be [up|down|create].');
  yargs.showHelp();
  process.exit(1);
}

if (argv['force-exit']) {
  console.log('Forcing exit');
  process.exit(0);
}
